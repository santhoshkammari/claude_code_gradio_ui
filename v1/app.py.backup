"""
"""
import gradio as gr
import json
import asyncio
import threading
from datetime import datetime
from pathlib import Path
from claude_agent_sdk import ClaudeSDKClient, ClaudeAgentOptions, AssistantMessage, TextBlock

tasks_file = Path("tasks.json")
client = None
loop = None

def init_event_loop():
    global loop
    if loop is None:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        threading.Thread(target=loop.run_forever, daemon=True).start()

async def init_claude():
    global client
    if not client:
        client = ClaudeSDKClient(ClaudeAgentOptions(
            allowed_tools=["Read", "Write", "Bash", "Grep"],
            permission_mode="acceptEdits"
        ))
        await client.connect()

async def chat_claude(msg, history):
    await init_claude()
    await client.query(msg)
    response = ""
    async for m in client.receive_response():
        if isinstance(m, AssistantMessage):
            for b in m.content:
                if isinstance(b, TextBlock):
                    response += b.text
    history = history or []
    history.append({"role": "user", "content": msg})
    history.append({"role": "assistant", "content": response})
    return history

def chat_sync(msg, history):
    init_event_loop()
    future = asyncio.run_coroutine_threadsafe(chat_claude(msg, history), loop)
    return future.result()

def load_tasks():
    if tasks_file.exists():
        return json.loads(tasks_file.read_text())
    return {"active": [], "done": [], "jams": []}

def save_tasks(tasks):
    tasks_file.write_text(json.dumps(tasks, indent=2))

def delete_task(task_id, category):
    tasks = load_tasks()
    tasks[category] = [t for t in tasks.get(category, []) if t.get("id") != task_id]
    save_tasks(tasks)
    return {"refresh": datetime.now().isoformat()}

def start_task(task_id, category):
    tasks = load_tasks()
    for t in tasks.get(category, []):
        if t.get("id") == task_id:
            t["status"] = "in_progress"
            t["section"] = "needs_review"
    save_tasks(tasks)
    return {"refresh": datetime.now().isoformat()}

def render_backlog(category):
    tasks = load_tasks()
    task_list = tasks.get(category, [])
    backlog = [t for t in task_list if t.get("section") == "backlog"]

    html = f"""
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
        <div style="width: 24px; height: 24px; border: 2px solid rgba(107, 114, 128, 0.3); border-radius: 50%; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);"></div>
        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #1f2937;">Backlog</h3>
        <span style="background: rgba(243, 244, 246, 0.6); color: #6b7280; padding: 4px 12px; border-radius: 16px; font-size: 14px; font-weight: 500; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">{len(backlog)}</span>
    </div>
    """

    if backlog:
        for idx, task in enumerate(backlog):
            task_id = task.get("id", "TASK-001")
            time = task.get("time", "Just now")
            description = task.get("description", "")

            html += f"""
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 13px; color: #6b7280;">ðŸ“‹ {task_id}</span>
                    <span style="font-size: 12px; color: #9ca3af;">{time}</span>
                </div>
                <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 6px;">{task['title']}</div>
                {f'<div style="font-size: 13px; color: #6b7280; line-height: 1.5; margin-bottom: 12px;">{description}</div>' if description else ''}
                <div style="display: flex; gap: 8px;">
                    <button style="background: #e5e7eb; color: #6b7280; border: none; padding: 6px 8px; border-radius: 6px; font-size: 13px; cursor: default; min-width: 36px;" disabled></button>
                    <button onclick="
                        const input = document.querySelector('[data-testid*=\\'textbox\\'][style*=\\'display: none\\']');
                        if (input && input.querySelector('textarea')) {{
                            const textarea = input.querySelector('textarea');
                            textarea.value = 'delete:{category}:{task_id}';
                            textarea.dispatchEvent(new Event('input', {{ bubbles: true }}));
                        }}
                    " style="background: #ef4444; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; flex: 1;">Delete</button>
                    <button onclick="
                        const input = document.querySelector('[data-testid*=\\'textbox\\'][style*=\\'display: none\\']');
                        if (input && input.querySelector('textarea')) {{
                            const textarea = input.querySelector('textarea');
                            textarea.value = 'start:{category}:{task_id}';
                            textarea.dispatchEvent(new Event('input', {{ bubbles: true }}));
                        }}
                    " style="background: #3b82f6; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; flex: 1;">Start â†’</button>
                </div>
            </div>
            """
    else:
        html += '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px;">No backlog tasks</div>'

    return html

def render_needs_review(category):
    tasks = load_tasks()
    task_list = tasks.get(category, [])
    needs_review = [t for t in task_list if t.get("section") == "needs_review"]

    html = f"""
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
        <div style="width: 20px; height: 20px; background: #10b981; border-radius: 50%;"></div>
        <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111827;">Needs review</h3>
        <span style="background: #f3f4f6; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 13px; font-weight: 500;">{len(needs_review)}</span>
    </div>
    """

    if needs_review:
        for idx, task in enumerate(needs_review):
            task_id = task.get("id", "TASK-001")
            time = task.get("time", "Just now")
            description = task.get("description", "")

            html += f"""
            <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <span style="font-size: 13px; color: #6b7280;">ðŸ“‹ {task_id}</span>
                    <span style="font-size: 12px; color: #9ca3af;">{time}</span>
                </div>
                <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 6px;">{task['title']}</div>
                {f'<div style="font-size: 13px; color: #6b7280; line-height: 1.5; margin-bottom: 12px;">{description}</div>' if description else ''}
                <div style="display: flex; gap: 8px;">
                    <button style="background: #e5e7eb; color: #6b7280; border: none; padding: 6px 8px; border-radius: 6px; font-size: 13px; cursor: default; min-width: 36px;" disabled></button>
                    <button onclick="
                        const input = document.querySelector('[data-testid*=\\'textbox\\'][style*=\\'display: none\\']');
                        if (input && input.querySelector('textarea')) {{
                            const textarea = input.querySelector('textarea');
                            textarea.value = 'delete:{category}:{task_id}';
                            textarea.dispatchEvent(new Event('input', {{ bubbles: true }}));
                        }}
                    " style="background: #ef4444; color: white; border: none; padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: pointer; flex: 2;">Delete</button>
                    <button style="background: #cbd5e1; color: #6b7280; border: none; padding: 6px 16px; border-radius: 6px; font-size: 13px; cursor: default; flex: 1;" disabled>Start â†’</button>
                </div>
            </div>
            """
    else:
        html += '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 14px;">No tasks in review</div>'

    return html

def add_task(title, section, category):
    if not title.strip():
        return render_backlog(category), render_needs_review(category), ""

    tasks = load_tasks()
    task_count = len(tasks.get(category, []))
    new_task = {
        "id": f"TASK-{task_count + 1:03d}",
        "title": title,
        "section": section,
        "description": "",
        "status": "open",
        "time": datetime.now().strftime("%I:%M %p"),
        "created": datetime.now().isoformat()
    }

    tasks[category].append(new_task)
    save_tasks(tasks)

    return render_backlog(category), render_needs_review(category), ""

def handle_action(command, category):
    if not command:
        return render_backlog(category), render_needs_review(category), ""

    parts = command.split(":")
    if len(parts) == 3:
        action, cat, task_id = parts
        if action == "delete":
            return delete_task(task_id, cat) + ("",)
        elif action == "start":
            return start_task(task_id, cat) + ("",)

    return render_backlog(category), render_needs_review(category), ""

with gr.Blocks() as demo:


    with gr.Sidebar(position='right', open=True,width="27%"):
        gr.Markdown("### Claude Agent")
        chatbot = gr.Chatbot(height=400, show_label=False)
        chat_input = gr.Textbox(
            placeholder="Message Claude...",
            show_label=False,
            container=False
        )
        chat_input.submit(chat_sync, [chat_input, chatbot], [chatbot]).then(lambda: "", None, chat_input)

    with gr.Sidebar(open=True, position='left',width="19%"):
        with gr.Tabs():
            with gr.Tab("a"):
                gr.Markdown("### Navigation")
            with gr.Tab("b"):
                gr.Markdown("### Claude Agent")
                chatbot = gr.Chatbot(height=400, show_label=False)
                chat_input = gr.Textbox(
                    placeholder="Message Claude...",
                    show_label=False,
                    container=False
                )
                chat_input.submit(chat_sync, [chat_input, chatbot], [chatbot]).then(lambda: "", None, chat_input)

    with gr.Tabs():
        with gr.Tab("Active"):
            active_state = gr.State({"refresh": datetime.now().isoformat()})

            @gr.render(inputs=active_state)
            def render_active(state):
                tasks = load_tasks()
                backlog = [t for t in tasks.get("active", []) if t.get("section") == "backlog"]
                needs_review = [t for t in tasks.get("active", []) if t.get("section") == "needs_review"]

                with gr.Row():
                    with gr.Column(scale=1):
                        gr.HTML(f"""
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 20px; height: 20px; border: 2px solid #6b7280; border-radius: 50%;"></div>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111827;">Backlog</h3>
                            <span style="background: #f3f4f6; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 13px; font-weight: 500;">{len(backlog)}</span>
                        </div>
                        """)

                        if backlog:
                            for task in backlog:
                                with gr.Group(elem_classes="task-card"):
                                    gr.HTML(f"""
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; color: #9ca3af;">ðŸ“‹ {task['id']}</span>
                                        <span style="font-size: 12px; color: #d1d5db;">{task['time']}</span>
                                    </div>
                                    <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 12px;">{task['title']}</div>
                                    """)
                                    if task.get('description'):
                                        gr.HTML(f"<div style='font-size: 13px; color: #6b7280; line-height: 1.5; margin-bottom: 12px;'>{task['description']}</div>")
                                    with gr.Row(elem_classes="no-wrap-row"):
                                        content_btn = gr.Button("", variant="secondary", size="sm", scale=1)
                                        del_btn = gr.Button("Delete", variant="stop", size="sm", scale=1)
                                        start_btn = gr.Button("Start â†’", variant="primary", size="sm", scale=1, elem_classes="start-btn")

                                        del_btn.click(
                                            fn=lambda tid=task['id']: delete_task(tid, "active"),
                                            outputs=[active_state]
                                        )
                                        start_btn.click(
                                            fn=lambda tid=task['id']: start_task(tid, "active"),
                                            outputs=[active_state]
                                        )
                        else:
                            gr.HTML("<div style='text-align: center; padding: 40px; color: #9ca3af;'>No backlog tasks</div>")

                    with gr.Column(scale=1):
                        gr.HTML(f"""
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div style="width: 20px; height: 20px; background: #10b981; border-radius: 50%;"></div>
                            <h3 style="margin: 0; font-size: 16px; font-weight: 600; color: #111827;">Needs review</h3>
                            <span style="background: #f3f4f6; color: #6b7280; padding: 2px 8px; border-radius: 12px; font-size: 13px; font-weight: 500;">{len(needs_review)}</span>
                        </div>
                        """)

                        if needs_review:
                            for task in needs_review:
                                with gr.Group(elem_classes="task-card"):
                                    gr.HTML(f"""
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 13px; color: #9ca3af;">ðŸ“‹ {task['id']}</span>
                                        <span style="font-size: 12px; color: #d1d5db;">In Review</span>
                                    </div>
                                    <div style="font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 12px;">{task['title']}</div>
                                    """)
                                    if task.get('description'):
                                        gr.HTML(f"<div style='font-size: 13px; color: #6b7280; line-height: 1.5; margin-bottom: 12px;'>{task['description']}</div>")
                                    del_btn = gr.Button("Delete", variant="stop", size="sm")
                                    del_btn.click(
                                        fn=lambda tid=task['id']: delete_task(tid, "active"),
                                        outputs=[active_state]
                                    )
                        else:
                            gr.HTML("<div style='text-align: center; padding: 40px; color: #9ca3af;'>No tasks in review</div>")


        with gr.Tab("Done"):
            done_state = gr.State({"refresh": datetime.now().isoformat()})

            @gr.render(inputs=done_state)
            def render_done(state):
                tasks = load_tasks()
                backlog = [t for t in tasks.get("done", []) if t.get("section") == "backlog"]
                needs_review = [t for t in tasks.get("done", []) if t.get("section") == "needs_review"]

                with gr.Row():
                    with gr.Column(scale=1):
                        gr.HTML(render_backlog("done"))
                    with gr.Column(scale=1):
                        gr.HTML(render_needs_review("done"))

        with gr.Tab("Jams"):
            jams_state = gr.State({"refresh": datetime.now().isoformat()})

            @gr.render(inputs=jams_state)
            def render_jams(state):
                tasks = load_tasks()
                backlog = [t for t in tasks.get("jams", []) if t.get("section") == "backlog"]
                needs_review = [t for t in tasks.get("jams", []) if t.get("section") == "needs_review"]

                with gr.Row():
                    with gr.Column(scale=1):
                        gr.HTML(render_backlog("jams"))
                    with gr.Column(scale=1):
                        gr.HTML(render_needs_review("jams"))

        with gr.Tab("AutoPlan"):
            gr.Markdown("AutoPlan content coming soon...")

    current_tab = gr.State("Active")

    with gr.Row(elem_classes="input-row"):
        with gr.Column(scale=1, elem_classes="input-wrapper"):
            task_input = gr.Textbox(
                placeholder="Add a task...",
                show_label=False,
                container=False,
                elem_classes="chat-input",
                lines=1,
                max_lines=5,
                autofocus=True
            )

    def add_task_from_input(title):
        add_task(title, "backlog", "active")
        return {"refresh": datetime.now().isoformat()}, ""

    task_input.submit(
        fn=add_task_from_input,
        inputs=[task_input],
        outputs=[active_state, task_input]
    )

if __name__ == "__main__":
    demo.launch(
        server_name="0.0.0.0",
        server_port=7860,
        css="""
            /* ChatGPT-style input */
            .input-row {
                position: sticky;
                bottom: 0;
                background: white;
                padding: 20px 0;
                border-top: 1px solid #e5e7eb;
                z-index: 100;
            }

            .input-wrapper {
                position: relative;
                max-width: 800px;
                margin: 0 auto;
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
            }

            .chat-input {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
            }

            .chat-input textarea {
                border-radius: 24px !important;
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                padding: 14px 18px !important;
                font-size: 16px !important;
                resize: none !important;
                box-shadow: 0 0 10px rgba(0,0,0,0.05) !important;
                overflow-y: hidden !important;
                scrollbar-width: none !important;
                background: rgba(255, 255, 255, 0.6) !important;
                backdrop-filter: blur(10px) !important;
                -webkit-backdrop-filter: blur(10px) !important;
            }

            .chat-input textarea::-webkit-scrollbar {
                display: none !important;
            }

            .chat-input textarea:focus {
                border-color: rgba(16, 163, 127, 0.8) !important;
                box-shadow: 0 0 0 3px rgba(16, 163, 127, 0.15) !important;
                outline: none !important;
                background: rgba(255, 255, 255, 0.8) !important;
            }

            footer {display: none !important;}
            .gradio-container {
                margin-bottom: 0 !important;
                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%) !important;
                min-height: 100vh !important;
            }

            /* Column styling - Glass Theme */
            .column {
                background: rgba(255, 255, 255, 0.6) !important;
                backdrop-filter: blur(16px) !important;
                -webkit-backdrop-filter: blur(16px) !important;
                border-radius: 20px !important;
                padding: 24px !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08) !important;
            }

            /* Task card styling - iOS Glass Theme */
            .task-card {
                background: rgba(255, 255, 255, 0.8) !important;
                backdrop-filter: blur(12px) !important;
                -webkit-backdrop-filter: blur(12px) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
                border-radius: 16px !important;
                padding: 20px !important;
                margin-bottom: 16px !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05) !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                min-width: 0 !important;
                flex-shrink: 1 !important;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            }

            .task-card:hover {
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12) !important;
                transform: translateY(-2px) !important;
                background: rgba(255, 255, 255, 0.9) !important;
            }

            /* Section headers */
            .section-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 16px;
                padding-bottom: 12px;
                border-bottom: 1px solid #f3f4f6;
            }

            /* Button styling - Modern iOS */
            button[variant="stop"] {
                background: rgba(255, 237, 213, 0.8) !important;
                color: #dc2626 !important;
                border: 1px solid rgba(255, 237, 213, 0.3) !important;
                border-radius: 12px !important;
                font-weight: 500 !important;
                font-size: 14px !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            button[variant="stop"]:hover {
                background: rgba(255, 237, 213, 0.9) !important;
                border-color: rgba(255, 237, 213, 0.5) !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15) !important;
            }

            button[variant="primary"] {
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.95) 100%) !important;
                color: white !important;
                border: none !important;
                border-radius: 12px !important;
                font-weight: 500 !important;
                font-size: 14px !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            button[variant="primary"]:hover {
                background: linear-gradient(135deg, rgba(37, 99, 235, 0.95) 0%, rgba(29, 78, 216, 1) 100%) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 6px 20px rgba(59, 130, 246, 0.35) !important;
            }

            .start-btn {
                background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.95) 100%) !important;
                color: white !important;
                border: none !important;
                border-radius: 12px !important;
                font-weight: 500 !important;
                font-size: 14px !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            .start-btn:hover {
                background: linear-gradient(135deg, rgba(37, 99, 235, 0.95) 0%, rgba(29, 78, 216, 1) 100%) !important;
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 16px rgba(59, 130, 246, 0.35) !important;
            }

            .no-wrap-row {
                display: flex !important;
                flex-wrap: nowrap !important;
                min-width: 0 !important;
            }

            .no-wrap-row button {
                flex: 1 1 auto !important;
                min-width: 0 !important;
                max-width: 100% !important;
            }

            button {
                border-radius: 8px !important;
                font-weight: 500 !important;
            }

            /* Input styling - Glass Theme */
            .input-container input, .input-container textarea {
                border: 1px solid rgba(255, 255, 255, 0.3) !important;
                border-radius: 12px !important;
                padding: 12px 16px !important;
                transition: all 0.3s ease !important;
                background: rgba(255, 255, 255, 0.6) !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
            }

            .input-container input:focus, .input-container textarea:focus {
                border-color: rgba(59, 130, 246, 0.8) !important;
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15) !important;
                background: rgba(255, 255, 255, 0.8) !important;
            }

            /* Tab styling - Glass Theme */
            .tab-nav button {
                border-radius: 12px 12px 0 0 !important;
                font-weight: 500 !important;
                color: rgba(107, 114, 128, 0.8) !important;
                transition: all 0.3s ease !important;
                background: rgba(255, 255, 255, 0.3) !important;
                backdrop-filter: blur(8px) !important;
                -webkit-backdrop-filter: blur(8px) !important;
                border: 1px solid rgba(255, 255, 255, 0.2) !important;
            }

            .tab-nav button:hover {
                background: rgba(255, 255, 255, 0.5) !important;
                color: #1f2937 !important;
                transform: translateY(-1px) !important;
            }

            .tab-nav button[aria-selected="true"] {
                background: rgba(255, 255, 255, 0.8) !important;
                border-bottom: 3px solid rgba(59, 130, 246, 0.8) !important;
                color: #3b82f6 !important;
                backdrop-filter: blur(12px) !important;
                -webkit-backdrop-filter: blur(12px) !important;
            }

            /* Empty state styling - Glass Theme */
            .empty-state {
                text-align: center;
                padding: 80px 20px;
                color: rgba(107, 114, 128, 0.8) !important;
                font-size: 16px !important;
                font-weight: 500 !important;
            }

            /* Sidebar styling - Glass Theme */
            .sidebar {
                background: rgba(255, 255, 255, 0.7) !important;
                border-left: 1px solid rgba(255, 255, 255, 0.2) !important;
                backdrop-filter: blur(12px) !important;
                -webkit-backdrop-filter: blur(12px) !important;
                box-shadow: -2px 0 12px rgba(0, 0, 0, 0.05) !important;
            }

            /* Add Task button special styling */
            button:contains("+ Task") {
                background: #f97316 !important;
                box-shadow: 0 2px 8px rgba(249, 115, 22, 0.25) !important;
            }

            button:contains("+ Task"):hover {
                background: #ea580c !important;
                box-shadow: 0 4px 12px rgba(249, 115, 22, 0.35) !important;
            }
        """
    )
